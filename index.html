<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galería de Fotos - Estilo Tinder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background: linear-gradient(to bottom, #000000, #1a0033);color:#fff;line-height:1.6;overflow-x:hidden;min-height:100vh;}
    header{background: linear-gradient(135deg, #ff00cc 0%, #3300ff 100%);color:white;text-align:center;padding:1rem 0;box-shadow:0 4px 30px rgba(255, 0, 204, 0.5);position:sticky;top:0;z-index:100;}
    .header-content{max-width:1200px;margin:0 auto;padding:0 1rem;}
    h1{font-size:1.8rem;letter-spacing:.5px;margin-bottom:.4rem;font-weight:700;text-shadow: 0 0 10px #ff00cc, 0 0 20px #ff00cc;}
    .subtitle{font-size:.85rem;opacity:.85;font-weight:300;max-width:600px;margin:0 auto;}
    .controls{display:flex;justify-content:center;gap:1rem;margin-top:1.2rem;flex-wrap:wrap;}
    .search-container{position:relative;max-width:350px;width:100%;}
    .search-container input{width:100%;padding:.7rem 1rem;padding-left:2.8rem;border-radius:50px;border:2px solid #00ffff;font-size:.9rem;background-color:rgba(0, 0, 0, 0.7);box-shadow:0 0 15px rgba(0, 255, 255, 0.5);color: white;}
    .search-container i{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:#00ffff;font-size:.9rem;}
    .download-btn{background: linear-gradient(135deg, #ff00cc 0%, #3300ff 100%);border:none;padding:.7rem 1.2rem;border-radius:50px;color:white;font-size:.9rem;font-weight:600;cursor:pointer;box-shadow:0 0 20px rgba(255, 0, 204, 0.7);transition:all .3s ease;display:flex;align-items:center;gap:0.5rem;}
    .download-btn:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 0 25px rgba(255, 0, 204, 0.9);}
    .download-btn:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none;}
    .download-options{display:flex;gap:0.5rem;margin-top:1rem;justify-content:center;flex-wrap:wrap;}
    .gallery-container{max-width:500px;margin:1.2rem auto;padding:0 .8rem;}
    .gallery{display:flex;flex-direction:column;align-items:center;gap:1.5rem;}
    .gallery-item{width:100%;max-width:400px;height:550px;background: linear-gradient(135deg, #ff00cc 0%, #3300ff 100%);border-radius:20px;overflow:hidden;box-shadow:0 10px 30px rgba(255, 0, 204, 0.5);display:flex;flex-direction:column;position:relative;animation:fadeIn .5s ease forwards;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    .image-container{position:relative;width:100%;height:75%;overflow:hidden;background:linear-gradient(45deg,#000000,#1a0033);}
    .gallery-image{width:100%;height:100%;object-fit:cover;transition:opacity .5s ease;opacity:0;}
    .gallery-image.loaded{opacity:1;}
    .gallery-info{padding:1rem;flex-grow:1;display:flex;flex-direction:column;justify-content:space-between;}
    .user-name{font-weight:600;font-size:1.2rem;margin-bottom:.5rem;color:#ffffff;display:flex;align-items:center;gap:.4rem;text-shadow: 0 0 5px #00ffff;}
    .user-name i{color:#00ffff;font-size:1rem;}
    .message-preview{font-size:1rem;color:#cccccc;overflow:hidden;flex-grow:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;}
    footer{text-align:center;padding:1.2rem;background: linear-gradient(135deg, #ff00cc 0%, #3300ff 100%);color:#ddd;margin-top:2rem;}
    .footer-logo{font-size:1.1rem;font-weight:bold;margin-bottom:.6rem;color:white;}
    .footer-logo span{color:#00ffff;}
    
    /* Checkbox styles */
    .checkbox-container{position:absolute;top:15px;right:15px;z-index:10;background:rgba(0,0,0,0.7);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;}
    .checkbox-container input[type="checkbox"]{display:none;}
    .checkbox-container label{display:inline-block;width:24px;height:24px;background:white;border-radius:50%;border:2px solid #ddd;cursor:pointer;position:relative;transition:all 0.2s ease;}
    .checkbox-container input[type="checkbox"]:checked + label{background:#ff00cc;border-color:#ff00cc;}
    .checkbox-container input[type="checkbox"]:checked + label:after{content:"✓";position:absolute;color:white;font-size:14px;font-weight:bold;top:50%;left:50%;transform:translate(-50%, -50%);}
    
    /* Selection controls */
    .selection-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding:0.5rem;background:rgba(0,0,0,0.3);border-radius:8px;flex-wrap:wrap;gap:0.5rem;border:1px solid #00ffff;box-shadow:0 0 10px rgba(0, 255, 255, 0.3);}
    .selection-info{font-size:0.9rem;font-weight:500;}
    .selection-actions{display:flex;gap:0.5rem;}
    .selection-btn{background:#6c757d;border:none;padding:0.5rem 1rem;border-radius:20px;color:white;font-size:0.8rem;cursor:pointer;transition:all .2s ease;}
    .selection-btn:hover{transform:scale(1.05);}
    .selection-btn.select-all{background: linear-gradient(135deg, #00ff00 0%, #00cccc 100%);}
    .selection-btn.select-all:hover{background: linear-gradient(135deg, #00cc00 0%, #00aaaa 100%);}
    .selection-btn.deselect-all{background: linear-gradient(135deg, #ff0000 0%, #ff00cc 100%);}
    .selection-btn.deselect-all:hover{background: linear-gradient(135deg, #cc0000 0%, #cc00aa 100%);}
    
    /* Loading styles */
    .loading{display:none;flex-direction:column;align-items:center;justify-content:center;padding:2rem;color:#666;}
    .loading i{font-size:2rem;margin-bottom:1rem;animation:spin 1s linear infinite;color:#ff00cc;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    
    /* End of results message */
    .end-results{text-align:center;padding:2rem;color:#888;display:none;}
    
    /* Cupid waiting animation */
    .cupid-container{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;color:#00ffff;text-align:center;}
    .cupid-container h2{margin-bottom:1.5rem;font-size:1.8rem;text-shadow:0 0 10px #00ffff;}
    .cupid-gif{width:200px;height:200px;border-radius:50%;object-fit:cover;box-shadow:0 0 30px rgba(0, 255, 255, 0.7);margin-bottom:2rem;}
    
    /* Tinder-like buttons */
    .tinder-buttons{display:flex;justify-content:center;gap:2rem;margin-top:1.5rem;}
    .tinder-btn{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border:none;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,0.2);transition:all 0.3s ease;}
    .tinder-btn.like{background:linear-gradient(135deg, #00ff00 0%, #00cc00 100%);color:white;}
    .tinder-btn.dislike{background:linear-gradient(135deg, #ff0000 0%, #cc0000 100%);color:white;}
    .tinder-btn:hover{transform:scale(1.1);}
    
    /* Date filter info */
    .date-filter{text-align:center;margin:0.5rem 0;font-size:0.9rem;color:#00ffff;text-shadow:0 0 5px #00ffff;}
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .gallery-item{height:500px;}
      .selection-controls{flex-direction:column;align-items:flex-start;}
      .selection-actions{width:100%;justify-content:space-between;}
      .image-container{height:70%;}
    }
  </style>
</head>
<body>
<header>
  <div class="header-content">
    <h1>❤️ GALERÍA TINDER STYLE ❤️</h1>
    <p class="subtitle">Imágenes compartidas desde el 14 de Septiembre 2025</p>
    <div class="date-filter">Mostrando solo imágenes recientes</div>
    <div class="controls">
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Buscar por nombre...">
      </div>
      <button id="downloadSelectedBtn" class="download-btn" disabled>
        <i class="fas fa-download"></i> Descargar seleccionadas
      </button>
    </div>
    <div class="download-options">
      <button id="selectAllBtn" class="selection-btn select-all">Seleccionar todas</button>
      <button id="deselectAllBtn" class="selection-btn deselect-all">Deseleccionar todas</button>
    </div>
  </div>
</header>

<div class="gallery-container">
  <div class="selection-controls">
    <div class="selection-info" id="selectionInfo">0 imágenes seleccionadas</div>
    <div class="selection-actions">
      <button id="selectPageBtn" class="selection-btn select-all">Seleccionar página</button>
      <button id="deselectPageBtn" class="selection-btn deselect-all">Deseleccionar página</button>
    </div>
  </div>
  
  <div id="cupidContainer" class="cupid-container" style="display: none;">
    <h2>¡No hay imágenes todavía!</h2>
    <img src="https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif" alt="Cupido esperando" class="cupid-gif">
    <p>El cupido está esperando a que lleguen más imágenes...</p>
  </div>
  
  <div id="gallery" class="gallery"></div>
  
  <div id="loading" class="loading">
    <i class="fas fa-spinner"></i>
    <p>Cargando imágenes...</p>
  </div>
  <div id="endResults" class="end-results">
    <p>No hay más imágenes para mostrar</p>
  </div>
</div>

<footer>
  <div class="footer-content">
    <div class="footer-logo">Tinder<span>Style</span></div>
    <p>Comparte momentos especiales con tus seres queridos</p>
    <p class="copyright">© 2025 Galería de Sorpresas. Todos los derechos reservados.</p>
  </div>
</footer>

<script>
  const SUPABASE_URL = 'https://cskqlyauszpgjvwgenth.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNza3FseWF1c3pwZ2p2d2dlbnRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MTY4ODMsImV4cCI6MjA3MDE5Mjg4M30.HAZEfpAH2AZzoDBmsUOe3O33oAFbcRIJksZLOyeRvPk';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const gallery = document.getElementById('gallery');
  const loading = document.getElementById('loading');
  const searchInput = document.getElementById('searchInput');
  const selectedCount = document.getElementById('selectedCount');
  const selectionInfo = document.getElementById('selectionInfo');
  const endResults = document.getElementById('endResults');
  const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const deselectAllBtn = document.getElementById('deselectAllBtn');
  const selectPageBtn = document.getElementById('selectPageBtn');
  const deselectPageBtn = document.getElementById('deselectPageBtn');
  const cupidContainer = document.getElementById('cupidContainer');

  let currentPage = 1;
  let itemsPerPage = 300;
  let isLoading = false;
  let allDataLoaded = false;
  let imagesData = [];
  let totalImagesCount = 0;
  let observer;
  let searchTerm = '';
  let selectedImages = new Set();
  let currentIndex = 0;

  // Función para inicializar el Intersection Observer para lazy loading
  function initIntersectionObserver() {
    if (observer) observer.disconnect();
    
    observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const src = img.getAttribute('data-src');
          
          if (src) {
            // Verificar si es HEIC y convertirlo si es necesario
            if (isHeic(src)) {
              convertHeicToJpeg(src).then(jpegUrl => {
                img.src = jpegUrl;
                img.classList.add('loaded');
                img.removeAttribute('data-src');
              }).catch(() => {
                // Si falla la conversión, intentar cargar la imagen original
                img.src = src;
                img.classList.add('loaded');
                img.removeAttribute('data-src');
              });
            } else {
              img.src = src;
              img.classList.add('loaded');
              img.removeAttribute('data-src');
            }
          }
          
          observer.unobserve(img);
        }
      });
    }, { rootMargin: '100px 0px' });
    
    // Observar todas las imágenes con data-src
    document.querySelectorAll('.gallery-image[data-src]').forEach(img => {
      observer.observe(img);
    });
  }

  // Función para verificar si es HEIC
  function isHeic(url) {
    return url.toLowerCase().endsWith('.heic');
  }

  // Función para convertir HEIC a JPEG
  async function convertHeicToJpeg(heicUrl) {
    try {
      const response = await fetch(heicUrl);
      const blob = await response.blob();
      const jpegBlob = await heic2any({ blob: blob, toType: 'image/jpeg', quality: 0.8 });
      return URL.createObjectURL(jpegBlob);
    } catch(e) {
      console.error('Error convirtiendo HEIC:', e);
      throw e;
    }
  }

  // Función para cargar imágenes
  async function loadImages(search = '') {
    if (isLoading || allDataLoaded) return;
    
    isLoading = true;
    loading.style.display = 'flex';
    endResults.style.display = 'none';
    
    try {
      let query = supabase.from('mensajes')
        .select('nombre, mensaje, imagen_url, created_at', { count: 'exact' })
        .gte('created_at', '2025-09-14') // Solo imágenes desde el 14 de septiembre 2025
        .order('created_at', { ascending: false })
        .range((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage - 1);
      
      if (search) {
        query = query.ilike('nombre', `%${search}%`);
      }
      
      const { data, error, count } = await query;
      
      if (error) throw error;
      
      // Actualizar contador total de imágenes
      if (count !== null) {
        totalImagesCount = count;
      }
      
      if (!data || data.length === 0) {
        allDataLoaded = true;
        if (currentPage === 1) {
          gallery.innerHTML = '';
          cupidContainer.style.display = 'flex';
        } else {
          endResults.style.display = 'block';
        }
        return;
      }
      
      // Ocultar cupido si hay imágenes
      cupidContainer.style.display = 'none';
      
      // Filtrar duplicados
      const newItems = data.filter(item => !imagesData.some(img => img.imagen_url === item.imagen_url));
      
      if (newItems.length === 0) {
        allDataLoaded = true;
        endResults.style.display = 'block';
        return;
      }
      
      imagesData = [...imagesData, ...newItems];
      
      // Crear elementos de galería
      newItems.forEach(item => {
        createGalleryItem(item);
      });
      
      // Inicializar Intersection Observer para las nuevas imágenes
      initIntersectionObserver();
      
      currentPage++;
      
    } catch(e) {
      console.error('Error cargando imágenes:', e);
    } finally {
      isLoading = false;
      loading.style.display = 'none';
    }
  }

  // Función para crear elementos de galería
  function createGalleryItem(item) {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.dataset.imageUrl = item.imagen_url;
    
    // Checkbox para selección
    const checkboxContainer = document.createElement('div');
    checkboxContainer.className = 'checkbox-container';
    checkboxContainer.innerHTML = `
      <input type="checkbox" id="checkbox-${item.imagen_url}" data-url="${item.imagen_url}">
      <label for="checkbox-${item.imagen_url}"></label>
    `;
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'image-container';
    
    const img = document.createElement('img');
    img.className = 'gallery-image';
    img.setAttribute('data-src', item.imagen_url);
    img.alt = `Imagen de ${item.nombre || 'Anónimo'}`;
    
    imageContainer.appendChild(img);
    
    const info = document.createElement('div');
    info.className = 'gallery-info';
    info.innerHTML = `
      <div class="user-name"><i class="fas fa-user"></i>${item.nombre || 'Anónimo'}</div>
      <div class="message-preview">${item.mensaje || ''}</div>
    `;
    
    // Botones tipo Tinder (solo decorativos)
    const tinderButtons = document.createElement('div');
    tinderButtons.className = 'tinder-buttons';
    tinderButtons.innerHTML = `
      <button class="tinder-btn dislike"><i class="fas fa-times"></i></button>
      <button class="tinder-btn like"><i class="fas fa-heart"></i></button>
    `;
    
    info.appendChild(tinderButtons);
    
    div.appendChild(checkboxContainer);
    div.appendChild(imageContainer);
    div.appendChild(info);
    gallery.appendChild(div);
    
    // Añadir evento al checkbox
    const checkbox = checkboxContainer.querySelector('input');
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        selectedImages.add(item.imagen_url);
      } else {
        selectedImages.delete(item.imagen_url);
      }
      updateSelectionInfo();
    });
  }

  // Actualizar información de selección
  function updateSelectionInfo() {
    const count = selectedImages.size;
    selectionInfo.textContent = `${count} imagen(es) seleccionada(s)`;
    downloadSelectedBtn.disabled = count === 0;
  }

  // Seleccionar todas las imágenes
  function selectAllImages() {
    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = true;
      selectedImages.add(checkbox.dataset.url);
    });
    updateSelectionInfo();
  }

  // Deseleccionar todas las imágenes
  function deselectAllImages() {
    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    selectedImages.clear();
    updateSelectionInfo();
  }

  // Seleccionar imágenes de la página actual
  function selectPageImages() {
    const currentPageImages = [];
    document.querySelectorAll('.gallery-item').forEach(item => {
      currentPageImages.push(item.dataset.imageUrl);
    });
    
    currentPageImages.forEach(url => {
      selectedImages.add(url);
    });
    
    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
      if (currentPageImages.includes(checkbox.dataset.url)) {
        checkbox.checked = true;
      }
    });
    
    updateSelectionInfo();
  }

  // Deseleccionar imágenes de la página actual
  function deselectPageImages() {
    const currentPageImages = [];
    document.querySelectorAll('.gallery-item').forEach(item => {
      currentPageImages.push(item.dataset.imageUrl);
    });
    
    currentPageImages.forEach(url => {
      selectedImages.delete(url);
    });
    
    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
      if (currentPageImages.includes(checkbox.dataset.url)) {
        checkbox.checked = false;
      }
    });
    
    updateSelectionInfo();
  }

  // Función para manejar el scroll infinito
  function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
      const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
      
      // Cargar más imágenes cuando estemos a 500px del final
      if (scrollTop + clientHeight >= scrollHeight - 500 && !isLoading && !allDataLoaded) {
        loadImages(searchTerm);
      }
    });
  }

  // Función para buscar imágenes
  function setupSearch() {
    let searchTimeout;
    
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTerm = e.target.value.trim();
      
      searchTimeout = setTimeout(() => {
        // Reiniciar variables de paginación
        currentPage = 1;
        imagesData = [];
        allDataLoaded = false;
        gallery.innerHTML = '';
        endResults.style.display = 'none';
        selectedImages.clear();
        updateSelectionInfo();
        
        // Cargar resultados de búsqueda
        loadImages(searchTerm);
      }, 500);
    });
  }

  // --- DESCARGAR SELECCIONADAS ---
  async function convertToPng(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext("2d").drawImage(img, 0, 0);
        canvas.toBlob(blob => resolve(blob), "image/png");
      };
      img.onerror = () => reject("Error al cargar la imagen");
      img.src = url;
    });
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function downloadSelectedImages() {
    if (selectedImages.size === 0) {
      alert("No hay imágenes seleccionadas.");
      return;
    }
    
    const nameCount = {};
    const selectedItems = imagesData.filter(item => selectedImages.has(item.imagen_url));
    
    for (const item of selectedItems) {
      try {
        const url = isHeic(item.imagen_url) ? await convertHeicToJpeg(item.imagen_url) : item.imagen_url;
        const pngBlob = await convertToPng(url);
        
        let safeName = (item.nombre || "Anonimo").replace(/[^a-z0-9]/gi, "_");
        nameCount[safeName] = (nameCount[safeName] || 0) + 1;
        const filename = `${safeName}_${nameCount[safeName]}.png`;
        
        downloadBlob(pngBlob, filename);
        await new Promise(r => setTimeout(r, 400)); // Pequeña pausa entre descargas
      } catch(e) {
        console.error("Error descargando imagen:", e);
      }
    }
  }

  // Inicializar la aplicación
  function initApp() {
    setupInfiniteScroll();
    setupSearch();
    document.getElementById("downloadSelectedBtn").addEventListener("click", downloadSelectedImages);
    selectAllBtn.addEventListener("click", selectAllImages);
    deselectAllBtn.addEventListener("click", deselectAllImages);
    selectPageBtn.addEventListener("click", selectPageImages);
    deselectPageBtn.addEventListener("click", deselectPageImages);
    
    // Cargar imágenes iniciales
    loadImages();
  }

  window.addEventListener("DOMContentLoaded", initApp);
</script>
</body>
</html>
